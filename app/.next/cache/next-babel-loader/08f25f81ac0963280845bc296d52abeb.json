{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nvar __jsx = React.createElement;\n// Render Prop\nimport React, { Component } from 'react';\nimport styled from 'styled-components';\nimport { Formik, Form, Field, ErrorMessage } from 'formik';\nimport { TextField } from 'formik-material-ui';\nimport fetch from 'isomorphic-unfetch';\nimport Button from \"@material-ui/core/Button\";\nimport Box from \"@material-ui/core/Box\";\nimport Head from 'next/head';\nimport window from 'global';\nimport { Select } from 'material-ui-formik-components/Select';\nimport { DatePicker, MuiPickersUtilsProvider } from '@material-ui/pickers';\nimport LuxonUtils from '@date-io/luxon';\n\nrequire(\"react-datepicker/dist/react-datepicker.css\");\n\nvar dateFormat = require('dateformat');\n\nimport Loader from 'react-loader-spinner';\nimport \"react-loader-spinner/dist/loader/css/react-spinner-loader.css\";\nimport Grid from '@material-ui/core/Grid';\nimport { BOX, TITLE, TEXT, CONTAINER, BUTTON, MYFORM, FIELD, GlobalStyle, DATEPICKER } from './component';\nvar liff = window.liff;\n\nvar App =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(App, _Component);\n\n  function App(props) {\n    var _this;\n\n    _classCallCheck(this, App);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(App).call(this, props));\n    _this.state = {\n      substitutes: [],\n      userId: null\n    };\n    return _this;\n  }\n\n  _createClass(App, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.liffInit();\n    }\n  }, {\n    key: \"liffInit\",\n    value: function liffInit() {\n      var _this2 = this;\n\n      try {\n        liff.init(function (data) {\n          var userId = data.context.userId;\n          var accessToken = liff.getAccessToken();\n          var URL_CHECKEXIST = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/checkExist\";\n          var body = {\n            userId: userId\n          };\n          fetch(URL_CHECKEXIST, {\n            method: 'post',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: _JSON$stringify(body)\n          }).then(function (res) {\n            return res.text();\n          }).then(function (result) {\n            if (result) {\n              _this2.setState({\n                userId: userId\n              });\n\n              _this2.lineAuth(userId, accessToken);\n            } else {\n              alert(\"請登入以查看假單\");\n              window.location.replace(\"https://teddybear-dev.firebaseapp.com/signIn\");\n            }\n          });\n        }, function (err) {\n          alert(err.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"lineAuth\",\n    value: function lineAuth(userId, accessToken) {\n      var _this3 = this;\n\n      try {\n        var url = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/lineAuth\";\n        var body = {\n          userId: userId,\n          accessToken: accessToken\n        };\n        fetch(url, {\n          method: 'post',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify(body)\n        }).then(function (res) {\n          return res.json();\n        }).then(function (result) {\n          if (result) {\n            var ubn = result.staff.ubn;\n            var department = result.staff.department;\n            var email = result.staff.email;\n            var idToken = result.token.idToken;\n\n            _this3.setState({\n              Authorization: idToken,\n              ubn: ubn,\n              email: email\n            });\n\n            _this3.getSubstitutes(ubn, department, idToken);\n          } else {\n            alert(\"lineAuth no result\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"getSubstitutes\",\n    value: function getSubstitutes(ubn, department, idToken) {\n      var _this4 = this;\n\n      try {\n        var URL_GETSUBSTITUTES = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/getSubstitutes\";\n        var url = URL_GETSUBSTITUTES + \"?ubn=\".concat(ubn, \"&query=department&value=\").concat(department);\n        var header = {\n          Authorization: idToken\n        };\n        fetch(url, {\n          method: 'get',\n          headers: header\n        }).then(function (res) {\n          return res.json();\n        }).then(function (result) {\n          if (result) {\n            _this4.createOptions(result.list);\n          } else {\n            alert(\"getSubstitutes no result\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"createOptions\",\n    value: function createOptions(arr) {\n      try {\n        var newList = [];\n\n        for (var i = 0; i < arr.length; i++) {\n          var obj = arr[i];\n          obj.value = _JSON$stringify({\n            \"name\": obj.name,\n            \"email\": obj.email\n          });\n          obj.label = obj.name;\n          delete obj.email;\n          delete obj.name; //push to list\n\n          newList.push(obj); // set substitutes\n\n          if (i == arr.length - 1) {\n            this.setState({\n              substitutes: newList\n            });\n          }\n        }\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"submitForm\",\n    value: function submitForm(values) {\n      try {\n        var URL_CREATELEAVE = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/leave/create\";\n        fetch(URL_CREATELEAVE, {\n          method: 'post',\n          headers: {\n            \"Authorization\": this.state.Authorization,\n            \"ubn\": this.state.ubn,\n            \"userId\": this.state.userId,\n            \"Content-Type\": \"application/json\"\n          },\n          body: _JSON$stringify(values)\n        }).then(function (res) {\n          return res.text();\n        }).then(function (result) {\n          if (result) {\n            liff.closeWindow();\n          } else {\n            alert(\"submitForm error\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this5 = this;\n\n      return __jsx(BOX, null, __jsx(GlobalStyle, null), __jsx(Head, null, __jsx(\"script\", {\n        src: \"https://d.line-scdn.net/liff/1.0/sdk.js\"\n      })), __jsx(\"body\", null, __jsx(BOX, null, __jsx(Formik, {\n        initialValues: {\n          startDate: dateFormat(new Date(), \"yyyy-mm-dd\"),\n          endDate: dateFormat(new Date(), \"yyyy-mm-dd\"),\n          leaveType: '',\n          leaveReason: '',\n          substitute: ''\n        },\n        validate: function validate(values) {\n          var errors = {}; // check for startDate\n\n          if (!values.startDate) {\n            errors.startDate = 'Required';\n          } // check for endDate\n\n\n          if (!values.endDate) {\n            errors.endDate = 'Required';\n          } // check for leaveType\n\n\n          if (!values.leaveType) {\n            errors.leaveType = 'Required';\n          } // check for leaveReason\n\n\n          if (!values.leaveReason) {\n            errors.leaveReason = 'Required';\n          } // check for substitute\n\n\n          if (!values.substitute) {\n            errors.substitute = 'Required';\n          }\n\n          return errors;\n        },\n        onSubmit: function onSubmit(values, _ref) {\n          var setSubmitting = _ref.setSubmitting;\n          values.email = _this5.state.email;\n\n          _this5.submitForm(values);\n\n          setSubmitting(false); //console.log('submitting', values);\n        }\n      }, function (_ref2) {\n        var isSubmitting = _ref2.isSubmitting,\n            values = _ref2.values,\n            setFieldValue = _ref2.setFieldValue;\n        return __jsx(CONTAINER, null, _this5.state.substitutes.length ? __jsx(MYFORM, null, __jsx(MuiPickersUtilsProvider, {\n          utils: LuxonUtils\n        }, __jsx(DATEPICKER, {\n          name: \"startDate\",\n          label: \"\\u958B\\u59CB\\u65E5\\u671F\",\n          format: \"yyyy-MM-dd\",\n          value: values.startDate,\n          onChange: function onChange(date) {\n            return setFieldValue('startDate', dateFormat(date, \"yyyy-mm-dd\"));\n          }\n        })), __jsx(MuiPickersUtilsProvider, {\n          utils: LuxonUtils\n        }, __jsx(DATEPICKER, {\n          name: \"endDate\",\n          label: \"\\u7D50\\u675F\\u65E5\\u671F\",\n          format: \"yyyy-MM-dd\",\n          value: values.endDate,\n          onChange: function onChange(date) {\n            return setFieldValue('endDate', dateFormat(date, \"yyyy-mm-dd\"));\n          }\n        })), __jsx(BOX, null, __jsx(FIELD, {\n          type: \"leaveType\",\n          name: \"leaveType\",\n          label: \"\\u5047\\u52E4\\u985E\\u5225\",\n          options: [{\n            value: '病假',\n            label: '病假'\n          }, {\n            value: '事假',\n            label: '事假'\n          }, {\n            value: '喪假',\n            label: '喪假'\n          }, {\n            value: '公假',\n            label: '公假'\n          }, {\n            value: '生理假',\n            label: '生理假'\n          }, {\n            value: '婚假',\n            label: '婚假'\n          }, {\n            value: '產假',\n            label: '產假'\n          }, {\n            value: '陪產假',\n            label: '陪產假'\n          }, {\n            value: '特休假',\n            label: '特休假'\n          }],\n          component: Select\n        })), __jsx(FIELD, {\n          type: \"leaveReason\",\n          name: \"leaveReason\",\n          label: \"\\u5047\\u52E4\\u4E8B\\u7531\",\n          component: TextField\n        }), __jsx(BOX, null, __jsx(FIELD, {\n          type: \"substitute\",\n          name: \"substitute\",\n          label: \"\\u8077\\u52D9\\u4EE3\\u7406\\u4EBA\",\n          options: _this5.state.substitutes,\n          component: Select\n        })), __jsx(\"br\", null), __jsx(BUTTON, {\n          type: \"submit\",\n          fontFamily: \"Candara\",\n          variant: \"contained\",\n          disabled: isSubmitting\n        }, \"\\u9001\\u51FA\\u5047\\u55AE\")) : __jsx(BOX, null, __jsx(Loader, {\n          type: \"ThreeDots\",\n          color: \"#1DB954\",\n          height: 80,\n          width: 80\n        })));\n      }))));\n    }\n  }]);\n\n  return App;\n}(Component);\n\nexport { App as default };","map":null,"metadata":{},"sourceType":"module"}