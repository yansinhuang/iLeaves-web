{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nvar __jsx = React.createElement;\n// Render Prop\nimport React, { Component } from 'react';\nimport styled from 'styled-components';\nimport { Formik, Form, Field, ErrorMessage } from 'formik';\nimport { TextField } from 'formik-material-ui';\nimport fetch from 'isomorphic-unfetch';\nimport Button from \"@material-ui/core/Button\";\nimport Box from \"@material-ui/core/Box\";\nimport Head from 'next/head';\nimport window from 'global';\nimport { Select } from 'material-ui-formik-components/Select';\nimport { DatePicker, MuiPickersUtilsProvider } from '@material-ui/pickers';\nimport LuxonUtils from '@date-io/luxon';\nimport Loader from 'react-loader-spinner';\nimport \"react-loader-spinner/dist/loader/css/react-spinner-loader.css\";\n\nrequire(\"react-datepicker/dist/react-datepicker.css\");\n\nvar dateFormat = require('dateformat');\n\nimport { BOX, TITLE, TEXT, CONTAINER, BUTTON, MYFORM, FIELD } from './component';\nvar liff = window.liff;\n\nvar App =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(App, _Component);\n\n  function App(props) {\n    var _this;\n\n    _classCallCheck(this, App);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(App).call(this, props));\n    _this.state = {\n      userId: null,\n      Authorization: null,\n      ubn: null,\n      leaveId: null,\n      leave: null,\n      status: null\n    };\n    return _this;\n  }\n\n  _createClass(App, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      this.getQuery();\n      this.liffInit();\n    }\n  }, {\n    key: \"getQuery\",\n    value: function getQuery() {\n      var urlParams = new URLSearchParams(window.location.search);\n      urlParams = urlParams.toString().split(\"&\");\n      var ubn = urlParams[0].split(\"=\")[1];\n      var leaveId = urlParams[1].split(\"=\")[1];\n      this.setState({\n        leaveId: leaveId\n      });\n    }\n  }, {\n    key: \"liffInit\",\n    value: function liffInit() {\n      var _this2 = this;\n\n      try {\n        liff.init(function (data) {\n          var userId = data.context.userId;\n          var accessToken = liff.getAccessToken();\n          var URL_CHECKEXIST = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/checkExist\";\n          var body = {\n            userId: userId\n          };\n          fetch(URL_CHECKEXIST, {\n            method: 'post',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: _JSON$stringify(body)\n          }).then(function (res) {\n            return res.text();\n          }).then(function (result) {\n            if (result) {\n              _this2.setState({\n                userId: userId\n              });\n\n              _this2.lineAuth(userId, accessToken);\n            } else {\n              alert(\"請登入以查看假單\");\n              window.location.replace(\"https://teddybear-dev.firebaseapp.com/signIn\");\n            }\n          });\n        }, function (err) {\n          alert(err.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"lineAuth\",\n    value: function lineAuth(userId, accessToken) {\n      var _this3 = this;\n\n      try {\n        var url = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/lineAuth\";\n        var body = {\n          userId: userId,\n          accessToken: accessToken\n        };\n        fetch(url, {\n          method: 'post',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify(body)\n        }).then(function (res) {\n          return res.json();\n        }).then(function (result) {\n          if (result) {\n            var ubn = result.staff.ubn;\n            var idToken = result.token.idToken;\n\n            _this3.setState({\n              Authorization: idToken,\n              ubn: ubn\n            });\n\n            _this3.checkStatus(idToken, ubn, _this3.state.leaveId);\n          } else {\n            alert(\"lineAuth no result\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"checkStatus\",\n    value: function checkStatus(Authorization, ubn, id) {\n      var _this4 = this;\n\n      try {\n        var URL_GETLEAVE = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/leave/target?ubn=\".concat(ubn, \"&id=\").concat(id);\n        fetch(URL_GETLEAVE, {\n          method: 'get',\n          headers: {\n            Authorization: Authorization\n          }\n        }).then(function (res) {\n          if (res.ok) {\n            return res.json();\n          }\n\n          throw new Error('checkStatus response was not ok.');\n        }).then(function (result) {\n          if (result.status != \"同意 (代理人)\") {\n            _this4.setState({\n              status: \"signed\"\n            });\n          } else {\n            _this4.getStaff(Authorization, ubn, result.email);\n\n            _this4.setState({\n              status: \"not signed\"\n            });\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"getStaff\",\n    value: function getStaff(Authorization, ubn, email) {\n      var _this5 = this;\n\n      try {\n        var URL_GETSTAFF = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/target?email=\".concat(email, \"&ubn=\").concat(ubn);\n        fetch(URL_GETSTAFF, {\n          method: 'get',\n          headers: {\n            \"Authorization\": Authorization\n          }\n        }).then(function (res) {\n          if (res.ok) {\n            return res.json();\n          }\n\n          throw new Error('getStaff response was not ok.');\n        }).then(function (result) {\n          _this5.setState({\n            userId_self: result.userId\n          });\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"updateLeave\",\n    value: function updateLeave(values) {\n      var _this6 = this;\n\n      try {\n        var URL_UPDATELEAVE = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/leave/update\";\n        fetch(URL_UPDATELEAVE, {\n          method: 'post',\n          headers: {\n            \"Authorization\": this.state.Authorization,\n            \"Content-Type\": \"application/json\"\n          },\n          body: _JSON$stringify(values)\n        }).then(function (res) {\n          if (res.ok) {\n            return res.json();\n          }\n\n          throw new Error('updateLeave response was not ok.');\n        }).then(function (result) {\n          _this6.setState({\n            leave: result\n          });\n\n          var messages = [{\n            type: \"text\",\n            text: \"拒絕成功\"\n          }];\n\n          _this6.pushMessage(_this6.state.userId, messages);\n\n          var substituteInfo = JSON.parse(result.substitute);\n          var messages_self = {\n            \"type\": \"flex\",\n            \"altText\": \"主管已拒絕假單\",\n            \"contents\": {\n              \"type\": \"bubble\",\n              \"styles\": {},\n              \"body\": {\n                \"type\": \"box\",\n                \"layout\": \"vertical\",\n                \"contents\": [{\n                  \"type\": \"text\",\n                  \"text\": \"主管\",\n                  \"weight\": \"bold\",\n                  \"color\": \"#1DB446\",\n                  \"size\": \"sm\"\n                }, {\n                  \"type\": \"text\",\n                  \"text\": \"已拒絕假單\",\n                  \"weight\": \"bold\",\n                  \"size\": \"xxl\",\n                  \"margin\": \"md\"\n                }, {\n                  \"type\": \"separator\",\n                  \"margin\": \"xxl\"\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"vertical\",\n                  \"margin\": \"xxl\",\n                  \"spacing\": \"sm\",\n                  \"contents\": [{\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [{\n                      \"type\": \"text\",\n                      \"text\": \"開始日期\",\n                      \"size\": \"sm\",\n                      \"color\": \"#555555\"\n                    }, {\n                      \"type\": \"text\",\n                      \"text\": result.startDate,\n                      \"size\": \"sm\",\n                      \"color\": \"#111111\",\n                      \"align\": \"end\"\n                    }]\n                  }, {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [{\n                      \"type\": \"text\",\n                      \"text\": \"結束日期\",\n                      \"size\": \"sm\",\n                      \"color\": \"#555555\"\n                    }, {\n                      \"type\": \"text\",\n                      \"text\": result.endDate,\n                      \"size\": \"sm\",\n                      \"color\": \"#111111\",\n                      \"align\": \"end\"\n                    }]\n                  }, {\n                    \"type\": \"separator\",\n                    \"margin\": \"xxl\"\n                  }, {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"margin\": \"xxl\",\n                    \"contents\": [{\n                      \"type\": \"text\",\n                      \"text\": \"假別\",\n                      \"size\": \"sm\",\n                      \"color\": \"#555555\"\n                    }, {\n                      \"type\": \"text\",\n                      \"text\": result.leaveType,\n                      \"size\": \"sm\",\n                      \"color\": \"#111111\",\n                      \"align\": \"end\"\n                    }]\n                  }, {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [{\n                      \"type\": \"text\",\n                      \"text\": \"請假原因\",\n                      \"size\": \"sm\",\n                      \"color\": \"#555555\"\n                    }, {\n                      \"type\": \"text\",\n                      \"text\": result.leaveReason,\n                      \"size\": \"sm\",\n                      \"color\": \"#111111\",\n                      \"align\": \"end\"\n                    }]\n                  }, {\n                    \"type\": \"box\",\n                    \"layout\": \"horizontal\",\n                    \"contents\": [{\n                      \"type\": \"text\",\n                      \"text\": \"代理人\",\n                      \"size\": \"sm\",\n                      \"color\": \"#555555\"\n                    }, {\n                      \"type\": \"text\",\n                      \"text\": substituteInfo.name,\n                      \"size\": \"sm\",\n                      \"color\": \"#111111\",\n                      \"align\": \"end\"\n                    }]\n                  }]\n                }, {\n                  \"type\": \"separator\",\n                  \"margin\": \"xxl\"\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"margin\": \"md\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"簽核狀態\",\n                    \"size\": \"xs\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": \"拒絕(主管)\",\n                    \"color\": \"#ff0000\",\n                    \"size\": \"xs\",\n                    \"align\": \"end\"\n                  }]\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"margin\": \"md\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"拒絕原因\",\n                    \"size\": \"xs\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": result.rejectReason,\n                    \"color\": \"#111111\",\n                    \"size\": \"xs\",\n                    \"align\": \"end\"\n                  }]\n                }]\n              }\n            }\n          };\n\n          _this6.pushMessage(_this6.state.userId_self, [messages_self]);\n\n          liff.closeWindow();\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"pushMessage\",\n    value: function pushMessage(userId, messages) {\n      try {\n        var URL_PUSHMESSAGE = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/message/pushMessage\";\n        var body = {\n          userId: userId,\n          messages: messages\n        };\n        fetch(URL_PUSHMESSAGE, {\n          method: 'post',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify(body)\n        }).then(function (res) {\n          if (res.ok) {\n            return res.json();\n          }\n\n          throw new Error('pushMessage response was not ok.');\n        }).then(function (result) {//liff.closeWindow();\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this7 = this;\n\n      return __jsx(BOX, null, __jsx(Head, null, __jsx(\"script\", {\n        src: \"https://d.line-scdn.net/liff/1.0/sdk.js\"\n      })), __jsx(\"body\", {\n        style: {\n          background: '#191414',\n          overflow: 'hidden'\n        }\n      }, __jsx(BOX, null, __jsx(Formik, {\n        initialValues: {\n          rejectReason: ''\n        },\n        validate: function validate(values) {\n          var errors = {}; // check for rejectReason\n\n          if (!values.rejectReason) {\n            errors.rejectReason = 'Required';\n          }\n\n          return errors;\n        },\n        onSubmit: function onSubmit(values, _ref) {\n          var setSubmitting = _ref.setSubmitting;\n          values.status = \"拒絕 (主管)\";\n          values.leaveId = _this7.state.leaveId;\n          values.ubn = _this7.state.ubn;\n\n          _this7.updateLeave(values);\n\n          setSubmitting(false); //console.log('submitting', values);\n        }\n      }, function (_ref2) {\n        var isSubmitting = _ref2.isSubmitting,\n            values = _ref2.values,\n            setFieldValue = _ref2.setFieldValue;\n        return __jsx(CONTAINER, null, _this7.state.userId && _this7.state.Authorization && _this7.state.ubn && _this7.state.leaveId && _this7.state.status == \"not signed\" ? __jsx(MYFORM, null, __jsx(FIELD, {\n          type: \"rejectReason\",\n          name: \"rejectReason\",\n          label: \"\\u62D2\\u7D55\\u539F\\u56E0\",\n          component: TextField\n        }), __jsx(\"br\", null), __jsx(\"br\", null), __jsx(BUTTON, {\n          type: \"submit\",\n          fontFamily: \"Candara\",\n          variant: \"contained\",\n          color: \"secondary\",\n          disabled: isSubmitting\n        }, \"\\u9001\\u51FA\")) : _this7.state.userId && _this7.state.Authorization && _this7.state.ubn && _this7.state.leaveId && _this7.state.status == \"signed\" ? __jsx(MYFORM, null, __jsx(\"label\", null, \"\\u6B64\\u5F35\\u5047\\u55AE\\u5DF2\\u7C3D\\u6838\")) : __jsx(LOADERBOX, null, __jsx(Loader, {\n          type: \"ThreeDots\",\n          color: \"#f50057\",\n          height: 80,\n          width: 80\n        })));\n      }))));\n    }\n  }]);\n\n  return App;\n}(Component);\n\nexport { App as default };","map":null,"metadata":{},"sourceType":"module"}