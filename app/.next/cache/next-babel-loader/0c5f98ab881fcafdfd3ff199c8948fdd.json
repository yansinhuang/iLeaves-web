{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nvar __jsx = React.createElement;\n// Render Prop\nimport React, { Component } from 'react';\nimport styled from 'styled-components';\nimport { Formik, Form, Field, ErrorMessage } from 'formik';\nimport { TextField } from 'formik-material-ui';\nimport fetch from 'isomorphic-unfetch';\nimport Button from \"@material-ui/core/Button\";\nimport Box from \"@material-ui/core/Box\";\nimport Head from 'next/head';\nimport window from 'global';\nimport { Select } from 'material-ui-formik-components/Select';\nimport { DatePicker, MuiPickersUtilsProvider } from '@material-ui/pickers';\nimport LuxonUtils from '@date-io/luxon';\n\nrequire(\"react-datepicker/dist/react-datepicker.css\");\n\nvar dateFormat = require('dateformat');\n\nimport Loader from 'react-loader-spinner';\nimport \"react-loader-spinner/dist/loader/css/react-spinner-loader.css\";\nimport Grid from '@material-ui/core/Grid'; //import { geolocated } from \"react-geolocated\";\n\nimport Geocode from \"react-geocode\";\nGeocode.setApiKey(\"AIzaSyC7jUeuFb_ujONIHAG-HKhyXggyd6hvz8s\");\nGeocode.setLanguage(\"zh-tw\");\nconst liff = window.liff;\nconst LOADERBOX = styled.div`\n  display: table;\n  margin: 0 auto;\n`;\nconst BOX = styled.div`\n  flex: 1;\n  background-color: #f08bc3;\n  margin: 5px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n`;\nconst TITLE = styled.h1`\n  display: flex;  \n  color: #F8F9F9;\n  font-family: Candara;\n  text-align: center;\n`;\nconst TEXT = styled.h5`\n  display: flex;\n  color: #F8F9F9;\n  font-family: Candara;\n  text-align: center;\n`;\nconst CONTAINER = styled.div`\n  display: flex;\n  height: 70vh;\n  width: 80vw;\n  padding: 15px;\n  margin: 9px;\n  background-color: #61a0f8;\n  flex-flow: column nowrap;\n  justify-content: center;\n  align-items: center;\n`;\nconst MYFORM = styled(Form)`\n  text-align: center;\n  padding-top: 2em;\n  padding-bottom: 2em;\n`;\nconst FIELD = styled(Field)`\n  width: 60vw;\n  margin: auto;\n`;\nconst BUTTON = styled(Button)`\n  display: flex;\n  variant: contained;\n  width: 100%;\n`;\nconst TomatoButton = styled.button`\n  color: tomato;\n  border-color: tomato;\n  width: 80%;\n`;\nexport default class App extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      userId: null,\n      latitude: null,\n      longitude: null\n    };\n  }\n\n  componentDidMount() {\n    this.liffInit();\n    this.getLocation();\n    setInterval(() => {\n      this.setState({\n        curTime: new Date().toLocaleTimeString('zh-TW')\n      });\n    }, 1000);\n  }\n\n  liffInit() {\n    try {\n      liff.init(data => {\n        const userId = data.context.userId;\n        const accessToken = liff.getAccessToken();\n        const URL_CHECKEXIST = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/checkExist\";\n        const body = {\n          userId: userId\n        };\n        fetch(URL_CHECKEXIST, {\n          method: 'post',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify(body)\n        }).then(res => {\n          return res.text();\n        }).then(result => {\n          if (result) {\n            this.setState({\n              userId: userId\n            });\n            this.lineAuth(userId, accessToken);\n          } else {\n            alert(\"請登入以查看假單\");\n            window.location.replace(\"https://teddybear-dev.firebaseapp.com/signIn\");\n          }\n        });\n      }, err => {\n        alert(err.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  lineAuth(userId, accessToken) {\n    try {\n      const url = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/lineAuth\";\n      const body = {\n        userId: userId,\n        accessToken: accessToken\n      };\n      fetch(url, {\n        method: 'post',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: _JSON$stringify(body)\n      }).then(res => {\n        return res.json();\n      }).then(result => {\n        if (result) {\n          const ubn = result.staff.ubn;\n          const department = result.staff.department;\n          const email = result.staff.email;\n          const idToken = result.token.idToken;\n          this.setState({\n            Authorization: idToken,\n            ubn: ubn,\n            email: email\n          });\n          this.getPunch();\n        } else {\n          alert(\"lineAuth no result\");\n        }\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  getLocation() {\n    try {\n      //alert(\"getLocation\");\n      let self = this;\n      navigator.geolocation.getCurrentPosition(function (position) {\n        //alert(position.coords.latitude);\n        //alert(position.coords.longitude);\n        self.setState({\n          latitude: position.coords.latitude,\n          longitude: position.coords.longitude\n        }); //alert(\"end!!\")\n\n        Geocode.fromLatLng(position.coords.latitude, position.coords.longitude).then(response => {\n          var address = response.results[0].formatted_address;\n          self.setState({\n            address: address\n          });\n        }, error => {\n          next(error);\n        });\n      }, error => alert(error.message));\n    } catch (err) {\n      alert(err);\n      next(err);\n    }\n  }\n\n  getPunch() {\n    try {\n      const URL_GETPUNCH = `https://us-central1-teddybear-dev.cloudfunctions.net/api/punch/getToday?ubn=${this.state.ubn}&query=email&value=${this.state.email}`;\n      fetch(URL_GETPUNCH, {\n        method: 'get',\n        headers: {\n          \"Authorization\": this.state.Authorization\n        }\n      }).then(res => {\n        return res.json();\n      }).then(result => {\n        let self = this;\n        self.setState({\n          punch: result\n        });\n\n        if (result.length == 0) {// able to punch in\n        } else if (result.length == 1 | result.length == 2) {\n          alert(\"今日已簽到\");\n        } else {\n          alert(\"error: too much punch data in a day\");\n        }\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  createPunch() {\n    try {\n      let self = this;\n      self.setState({\n        punched: true\n      });\n      const URL_CREATEPUNCH = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/punch/create\";\n      fetch(URL_CREATEPUNCH, {\n        method: 'post',\n        headers: {\n          \"Authorization\": this.state.Authorization,\n          \"ubn\": this.state.ubn,\n          \"Content-Type\": \"application/json\"\n        },\n        body: _JSON$stringify({\n          \"latitude\": this.state.latitude,\n          \"longitude\": this.state.longitude,\n          \"address\": this.state.address,\n          \"type\": \"簽到\",\n          \"email\": this.state.email\n        })\n      }).then(res => {\n        return res.text();\n      }).then(result => {\n        if (result) {\n          //liff.closeWindow();\n          alert(\"簽到成功\");\n        } else {\n          alert(\"punch error\");\n        }\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  render() {\n    return __jsx(\"div\", null, __jsx(Head, null, __jsx(\"script\", {\n      src: \"https://d.line-scdn.net/liff/1.0/sdk.js\"\n    })), __jsx(\"body\", {\n      style: {\n        background: '#34495E',\n        display: 'flex',\n        \"justify-content\": \"center\",\n        \"align-items\": \"center\"\n      }\n    }, __jsx(CONTAINER, null, this.state.email && this.state.punch && this.state.address ? __jsx(\"div\", null, __jsx(BOX, null, __jsx(TITLE, null, \" \", this.state.curTime, \" \")), __jsx(BOX, null, __jsx(TEXT, null, \"\\u73FE\\u5728\\u4F4D\\u7F6E\\uFF1A \", this.state.address)), __jsx(BOX, null, __jsx(BUTTON, {\n      fontFamily: \"Candara\",\n      variant: \"contained\",\n      color: \"secondary\",\n      disabled: !(this.state.latitude && this.state.longitude && this.state.address && this.state.punch.length == 0 && !this.state.punched),\n      onClick: () => {\n        this.createPunch();\n      }\n    }, \"\\u7C3D\\u5230\"))) : __jsx(BOX, null, __jsx(Loader, {\n      type: \"ThreeDots\",\n      color: \"#f50057\",\n      height: 80,\n      width: 80\n    })))));\n  }\n\n}","map":null,"metadata":{},"sourceType":"module"}