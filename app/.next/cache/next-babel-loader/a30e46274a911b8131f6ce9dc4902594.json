{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nvar __jsx = React.createElement;\n// Render Prop\nimport React, { Component } from 'react';\nimport { Formik, ErrorMessage } from 'formik';\nimport { TextField } from 'formik-material-ui';\nimport fetch from 'isomorphic-unfetch';\nimport Head from 'next/head';\nimport window from 'global';\nimport Loader from 'react-loader-spinner';\nimport \"react-loader-spinner/dist/loader/css/react-spinner-loader.css\";\nimport { BOX, TITLE, TEXT, CONTAINER, BUTTON, MYFORM, FIELD, GlobalStyle } from './component';\nconst liff = window.liff;\nexport default class App extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      userId: null,\n      Authorization: null,\n      ubn: null,\n      leaveId: null,\n      leave: null,\n      status: null\n    };\n  }\n\n  componentDidMount() {\n    this.getQuery();\n    this.liffInit();\n  }\n\n  getQuery() {\n    let urlParams = new URLSearchParams(window.location.search);\n    urlParams = urlParams.toString().split(\"&\");\n    const ubn = urlParams[0].split(\"=\")[1];\n    const leaveId = urlParams[1].split(\"=\")[1];\n    this.setState({\n      leaveId: leaveId\n    });\n  }\n\n  liffInit() {\n    try {\n      liff.init(data => {\n        const userId = data.context.userId;\n        const accessToken = liff.getAccessToken();\n        const URL_CHECKEXIST = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/checkExist\";\n        const body = {\n          userId: userId\n        };\n        fetch(URL_CHECKEXIST, {\n          method: 'post',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify(body)\n        }).then(res => {\n          return res.text();\n        }).then(result => {\n          if (result) {\n            this.setState({\n              userId: userId\n            });\n            this.lineAuth(userId, accessToken);\n          } else {\n            alert(\"請登入以查看假單\");\n            window.location.replace(\"https://teddybear-dev.firebaseapp.com/signIn\");\n          }\n        });\n      }, err => {\n        alert(err.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  lineAuth(userId, accessToken) {\n    try {\n      const url = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/lineAuth\";\n      const body = {\n        userId: userId,\n        accessToken: accessToken\n      };\n      fetch(url, {\n        method: 'post',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: _JSON$stringify(body)\n      }).then(res => {\n        return res.json();\n      }).then(result => {\n        if (result) {\n          const ubn = result.staff.ubn; //const department = result.staff.department;\n          //const email = result.staff.email;\n\n          const idToken = result.token.idToken;\n          this.setState({\n            Authorization: idToken,\n            ubn: ubn\n          });\n          this.checkStatus(idToken, ubn, this.state.leaveId);\n        } else {\n          alert(\"lineAuth no result\");\n        }\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  checkStatus(Authorization, ubn, id) {\n    try {\n      const URL_GETLEAVE = `https://us-central1-teddybear-dev.cloudfunctions.net/api/leave/target?ubn=${ubn}&id=${id}`;\n      fetch(URL_GETLEAVE, {\n        method: 'get',\n        headers: {\n          Authorization: Authorization\n        }\n      }).then(res => {\n        if (res.ok) {\n          return res.json();\n        }\n\n        throw new Error('checkStatus response was not ok.');\n      }).then(result => {\n        if (result.status != \"等待簽核\") {\n          //alert(\"此張假單已簽核\");\n          this.setState({\n            status: \"signed\"\n          }); //window.location.replace(\"https://teddybear-dev.firebaseapp.com/alreadyApproved/\");\n        } else {\n          this.getStaff(Authorization, ubn, result.email);\n          this.setState({\n            status: \"not signed\"\n          });\n        }\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  getStaff(Authorization, ubn, email) {\n    try {\n      const URL_GETSTAFF = `https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/target?email=${email}&ubn=${ubn}`;\n      fetch(URL_GETSTAFF, {\n        method: 'get',\n        headers: {\n          \"Authorization\": Authorization\n        }\n      }).then(res => {\n        if (res.ok) {\n          return res.json();\n        }\n\n        throw new Error('getStaff response was not ok.');\n      }).then(result => {\n        this.setState({\n          userId_self: result.userId\n        });\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  updateLeave(values) {\n    try {\n      const URL_UPDATELEAVE = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/leave/update\";\n      fetch(URL_UPDATELEAVE, {\n        method: 'post',\n        headers: {\n          \"Authorization\": this.state.Authorization,\n          \"Content-Type\": \"application/json\"\n        },\n        body: _JSON$stringify(values)\n      }).then(res => {\n        if (res.ok) {\n          return res.json();\n        }\n\n        throw new Error('updateLeave response was not ok.');\n      }).then(result => {\n        this.setState({\n          leave: result\n        });\n        const messages = [{\n          type: \"text\",\n          text: \"拒絕成功\"\n        }];\n        this.pushMessage(this.state.userId, messages);\n        const substituteInfo = JSON.parse(result.substitute);\n        const messages_self = {\n          \"type\": \"flex\",\n          \"altText\": \"代理人已拒絕假單\",\n          \"contents\": {\n            \"type\": \"bubble\",\n            \"styles\": {},\n            \"body\": {\n              \"type\": \"box\",\n              \"layout\": \"vertical\",\n              \"contents\": [{\n                \"type\": \"text\",\n                \"text\": \"代理人\",\n                \"weight\": \"bold\",\n                \"color\": \"#1DB446\",\n                \"size\": \"sm\"\n              }, {\n                \"type\": \"text\",\n                \"text\": \"已拒絕假單\",\n                \"weight\": \"bold\",\n                \"size\": \"xxl\",\n                \"margin\": \"md\"\n              }, {\n                \"type\": \"separator\",\n                \"margin\": \"xxl\"\n              }, {\n                \"type\": \"box\",\n                \"layout\": \"vertical\",\n                \"margin\": \"xxl\",\n                \"spacing\": \"sm\",\n                \"contents\": [{\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"開始日期\",\n                    \"size\": \"sm\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": result.startDate,\n                    \"size\": \"sm\",\n                    \"color\": \"#111111\",\n                    \"align\": \"end\"\n                  }]\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"結束日期\",\n                    \"size\": \"sm\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": result.endDate,\n                    \"size\": \"sm\",\n                    \"color\": \"#111111\",\n                    \"align\": \"end\"\n                  }]\n                }, {\n                  \"type\": \"separator\",\n                  \"margin\": \"xxl\"\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"margin\": \"xxl\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"假別\",\n                    \"size\": \"sm\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": result.leaveType,\n                    \"size\": \"sm\",\n                    \"color\": \"#111111\",\n                    \"align\": \"end\"\n                  }]\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"請假原因\",\n                    \"size\": \"sm\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": result.leaveReason,\n                    \"size\": \"sm\",\n                    \"color\": \"#111111\",\n                    \"align\": \"end\"\n                  }]\n                }, {\n                  \"type\": \"box\",\n                  \"layout\": \"horizontal\",\n                  \"contents\": [{\n                    \"type\": \"text\",\n                    \"text\": \"代理人\",\n                    \"size\": \"sm\",\n                    \"color\": \"#555555\"\n                  }, {\n                    \"type\": \"text\",\n                    \"text\": substituteInfo.name,\n                    \"size\": \"sm\",\n                    \"color\": \"#111111\",\n                    \"align\": \"end\"\n                  }]\n                }]\n              }, {\n                \"type\": \"separator\",\n                \"margin\": \"xxl\"\n              }, {\n                \"type\": \"box\",\n                \"layout\": \"horizontal\",\n                \"margin\": \"md\",\n                \"contents\": [{\n                  \"type\": \"text\",\n                  \"text\": \"簽核狀態\",\n                  \"size\": \"xs\",\n                  \"color\": \"#555555\"\n                }, {\n                  \"type\": \"text\",\n                  \"text\": \"拒絕(代理人)\",\n                  \"color\": \"#ff0000\",\n                  \"size\": \"xs\",\n                  \"align\": \"end\"\n                }]\n              }, {\n                \"type\": \"box\",\n                \"layout\": \"horizontal\",\n                \"margin\": \"md\",\n                \"contents\": [{\n                  \"type\": \"text\",\n                  \"text\": \"拒絕原因\",\n                  \"size\": \"xs\",\n                  \"color\": \"#555555\"\n                }, {\n                  \"type\": \"text\",\n                  \"text\": result.rejectReason,\n                  \"color\": \"#111111\",\n                  \"size\": \"xs\",\n                  \"align\": \"end\"\n                }]\n              }]\n            }\n          }\n        };\n        ;\n        this.pushMessage(this.state.userId_self, [messages_self]);\n        liff.closeWindow();\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  pushMessage(userId, messages) {\n    try {\n      const URL_PUSHMESSAGE = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/message/pushMessage\";\n      const body = {\n        userId: userId,\n        messages: messages\n      };\n      fetch(URL_PUSHMESSAGE, {\n        method: 'post',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: _JSON$stringify(body)\n      }).then(res => {\n        if (res.ok) {\n          return res.json();\n        }\n\n        throw new Error('pushMessage response was not ok.');\n      }).then(result => {//liff.closeWindow();\n      }).catch(function (error) {\n        alert(error.message);\n      });\n    } catch (err) {\n      next(err);\n    }\n  }\n\n  render() {\n    return __jsx(BOX, null, __jsx(GlobalStyle, null), __jsx(Head, null, __jsx(\"script\", {\n      src: \"https://d.line-scdn.net/liff/1.0/sdk.js\"\n    })), __jsx(\"body\", null, __jsx(BOX, null, __jsx(Formik, {\n      initialValues: {\n        rejectReason: ''\n      },\n      validate: values => {\n        const errors = {}; // check for rejectReason\n\n        if (!values.rejectReason) {\n          errors.rejectReason = 'Required';\n        }\n\n        return errors;\n      },\n      onSubmit: (values, {\n        setSubmitting\n      }) => {\n        values.status = \"拒絕 (代理人)\";\n        values.leaveId = this.state.leaveId;\n        values.ubn = this.state.ubn;\n        this.updateLeave(values);\n        setSubmitting(false); //console.log('submitting', values);\n      }\n    }, ({\n      isSubmitting,\n      values,\n      setFieldValue\n    }) => __jsx(CONTAINER, null, this.state.userId && this.state.Authorization && this.state.ubn && this.state.leaveId && this.state.status == \"not signed\" ? __jsx(MYFORM, null, __jsx(FIELD, {\n      type: \"rejectReason\",\n      name: \"rejectReason\",\n      label: \"\\u62D2\\u7D55\\u539F\\u56E0\",\n      component: TextField\n    }), __jsx(\"br\", null), __jsx(\"br\", null), __jsx(BUTTON, {\n      type: \"submit\",\n      fontFamily: \"Candara\",\n      variant: \"contained\",\n      color: \"secondary\",\n      disabled: isSubmitting\n    }, \"\\u9001\\u51FA\")) : this.state.userId && this.state.Authorization && this.state.ubn && this.state.leaveId && this.state.status == \"signed\" ? __jsx(MYFORM, null, __jsx(\"label\", null, \"\\u6B64\\u5F35\\u5047\\u55AE\\u5DF2\\u7C3D\\u6838\")) : __jsx(BOX, null, __jsx(Loader, {\n      type: \"ThreeDots\",\n      color: \"#1DB954\",\n      height: 80,\n      width: 80\n    })))))));\n  }\n\n}","map":null,"metadata":{},"sourceType":"module"}