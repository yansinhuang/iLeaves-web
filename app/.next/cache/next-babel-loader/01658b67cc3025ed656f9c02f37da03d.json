{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _classCallCheck from \"@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _inherits from \"@babel/runtime-corejs2/helpers/esm/inherits\";\nimport _taggedTemplateLiteral from \"@babel/runtime-corejs2/helpers/esm/taggedTemplateLiteral\";\nvar __jsx = React.createElement;\n\nfunction _templateObject5() {\n  var data = _taggedTemplateLiteral([\"\\n  display: flex;\\n  variant: contained;\\n  width: 100%;\\n\"]);\n\n  _templateObject5 = function _templateObject5() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _templateObject4() {\n  var data = _taggedTemplateLiteral([\"\\n  display: flex;\\n  height: 65vh;\\n  width: 75vw;\\n  padding: 30px;\\n  margin: 4px;\\n  background-color: #FFFFFF;\\n  flex-flow: column nowrap;\\n  justify-content: center;\\n  align-items: center;\\n\"]);\n\n  _templateObject4 = function _templateObject4() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _templateObject3() {\n  var data = _taggedTemplateLiteral([\"\\n  display: flex;\\n  color: #1C2833;\\n  font-family: Candara;\\n  text-align: center;\\n\"]);\n\n  _templateObject3 = function _templateObject3() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _templateObject2() {\n  var data = _taggedTemplateLiteral([\"\\n  display: flex;  \\n  color: #1C2833;\\n  font-family: Candara;\\n  text-align: center;\\n\"]);\n\n  _templateObject2 = function _templateObject2() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteral([\"\\n\\n  padding: 0px;\\n  margin: 5px;\\n  display: flex;\\n  justify-content: center;\\n  align-items: center;\\n\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\n// Render Prop\nimport React, { Component } from 'react';\nimport styled from 'styled-components';\nimport { Formik, Form, Field, ErrorMessage } from 'formik';\nimport { TextField } from 'formik-material-ui';\nimport fetch from 'isomorphic-unfetch';\nimport Button from \"@material-ui/core/Button\";\nimport Box from \"@material-ui/core/Box\";\nimport Head from 'next/head';\nimport window from 'global';\nimport { Select } from 'material-ui-formik-components/Select';\nimport { DatePicker, MuiPickersUtilsProvider } from '@material-ui/pickers';\nimport LuxonUtils from '@date-io/luxon';\n\nrequire(\"react-datepicker/dist/react-datepicker.css\");\n\nvar dateFormat = require('dateformat');\n\nimport Loader from 'react-loader-spinner';\nimport \"react-loader-spinner/dist/loader/css/react-spinner-loader.css\";\nimport Grid from '@material-ui/core/Grid'; //import { geolocated } from \"react-geolocated\";\n\nimport Geocode from \"react-geocode\";\nGeocode.setApiKey(\"AIzaSyC7jUeuFb_ujONIHAG-HKhyXggyd6hvz8s\");\nGeocode.setLanguage(\"zh-tw\");\nvar liff = window.liff;\nvar BOX = styled.div(_templateObject());\nvar TITLE = styled.h1(_templateObject2());\nvar TEXT = styled.h4(_templateObject3());\nvar CONTAINER = styled.div(_templateObject4());\nvar BUTTON = styled(Button)(_templateObject5());\n\nvar App =\n/*#__PURE__*/\nfunction (_Component) {\n  _inherits(App, _Component);\n\n  function App(props) {\n    var _this;\n\n    _classCallCheck(this, App);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(App).call(this, props));\n    _this.state = {\n      userId: null,\n      latitude: null,\n      longitude: null\n    };\n    return _this;\n  }\n\n  _createClass(App, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      this.liffInit();\n      this.getLocation();\n      setInterval(function () {\n        _this2.setState({\n          curTime: new Date().toLocaleTimeString('zh-TW')\n        });\n      }, 1000);\n    }\n  }, {\n    key: \"liffInit\",\n    value: function liffInit() {\n      var _this3 = this;\n\n      try {\n        liff.init(function (data) {\n          var userId = data.context.userId;\n          var accessToken = liff.getAccessToken();\n          var URL_CHECKEXIST = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/checkExist\";\n          var body = {\n            userId: userId\n          };\n          fetch(URL_CHECKEXIST, {\n            method: 'post',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: _JSON$stringify(body)\n          }).then(function (res) {\n            return res.text();\n          }).then(function (result) {\n            if (result) {\n              _this3.setState({\n                userId: userId\n              });\n\n              _this3.lineAuth(userId, accessToken);\n            } else {\n              alert(\"請登入以查看假單\");\n              window.location.replace(\"https://teddybear-dev.firebaseapp.com/signIn\");\n            }\n          });\n        }, function (err) {\n          alert(err.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"lineAuth\",\n    value: function lineAuth(userId, accessToken) {\n      var _this4 = this;\n\n      try {\n        var url = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/staff/lineAuth\";\n        var body = {\n          userId: userId,\n          accessToken: accessToken\n        };\n        fetch(url, {\n          method: 'post',\n          headers: {\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify(body)\n        }).then(function (res) {\n          return res.json();\n        }).then(function (result) {\n          if (result) {\n            var ubn = result.staff.ubn;\n            var department = result.staff.department;\n            var email = result.staff.email;\n            var idToken = result.token.idToken;\n\n            _this4.setState({\n              Authorization: idToken,\n              ubn: ubn,\n              email: email\n            });\n\n            _this4.getPunch();\n          } else {\n            alert(\"lineAuth no result\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"getLocation\",\n    value: function getLocation() {\n      try {\n        //alert(\"getLocation\");\n        var self = this;\n        navigator.geolocation.getCurrentPosition(function (position) {\n          //alert(position.coords.latitude);\n          //alert(position.coords.longitude);\n          self.setState({\n            latitude: position.coords.latitude,\n            longitude: position.coords.longitude\n          }); //alert(\"end!!\")\n\n          Geocode.fromLatLng(position.coords.latitude, position.coords.longitude).then(function (response) {\n            var address = response.results[0].formatted_address;\n            self.setState({\n              address: address\n            });\n          }, function (error) {\n            next(error);\n          });\n        }, function (error) {\n          return alert(error.message);\n        });\n      } catch (err) {\n        alert(err);\n        next(err);\n      }\n    }\n  }, {\n    key: \"getPunch\",\n    value: function getPunch() {\n      var _this5 = this;\n\n      try {\n        var URL_GETPUNCH = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/punch/getToday?ubn=\".concat(this.state.ubn, \"&query=email&value=\").concat(this.state.email);\n        fetch(URL_GETPUNCH, {\n          method: 'get',\n          headers: {\n            \"Authorization\": this.state.Authorization\n          }\n        }).then(function (res) {\n          return res.json();\n        }).then(function (result) {\n          var self = _this5;\n          self.setState({\n            punch: result\n          });\n\n          if (result.length == 0) {\n            alert(\"請先簽到\");\n          } else if (result.length == 1) {// able to punch out\n          } else if (result.length == 2) {\n            alert(\"今日已簽退\");\n          } else {\n            alert(\"error: too much punch data in a day\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"createPunch\",\n    value: function createPunch() {\n      try {\n        var self = this;\n        self.setState({\n          punched: true\n        });\n        var URL_CREATEPUNCH = \"https://us-central1-teddybear-dev.cloudfunctions.net/api/punch/create\";\n        fetch(URL_CREATEPUNCH, {\n          method: 'post',\n          headers: {\n            \"Authorization\": this.state.Authorization,\n            \"ubn\": this.state.ubn,\n            \"Content-Type\": \"application/json\"\n          },\n          body: _JSON$stringify({\n            \"latitude\": this.state.latitude,\n            \"longitude\": this.state.longitude,\n            \"address\": this.state.address,\n            \"type\": \"簽退\",\n            \"email\": this.state.email\n          })\n        }).then(function (res) {\n          return res.text();\n        }).then(function (result) {\n          if (result) {\n            //liff.closeWindow();\n            alert(\"簽退成功\");\n          } else {\n            alert(\"punch error\");\n          }\n        })[\"catch\"](function (error) {\n          alert(error.message);\n        });\n      } catch (err) {\n        next(err);\n      }\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this6 = this;\n\n      return __jsx(\"div\", null, __jsx(Head, null, __jsx(\"script\", {\n        src: \"https://d.line-scdn.net/liff/1.0/sdk.js\"\n      })), __jsx(\"body\", {\n        style: {\n          background: '#34495E',\n          display: 'flex',\n          \"justify-content\": \"center\",\n          \"align-items\": \"center\"\n        }\n      }, __jsx(CONTAINER, null, this.state.email && this.state.punch && this.state.address ? __jsx(\"div\", null, __jsx(BOX, null, __jsx(TITLE, null, \" \", this.state.curTime, \" \")), __jsx(BOX, null, __jsx(TEXT, null, \"\\u73FE\\u5728\\u4F4D\\u7F6E\\uFF1A \", this.state.address)), __jsx(BOX, null, __jsx(BUTTON, {\n        fontFamily: \"Candara\",\n        variant: \"contained\",\n        color: \"secondary\",\n        disabled: !(this.state.latitude && this.state.longitude && this.state.address && this.state.punch.length == 1 && !this.state.punched),\n        onClick: function onClick() {\n          _this6.createPunch();\n        }\n      }, \"\\u7C3D\\u5230\"))) : __jsx(BOX, null, __jsx(Loader, {\n        type: \"ThreeDots\",\n        color: \"#f50057\",\n        height: 80,\n        width: 80\n      })))));\n    }\n  }]);\n\n  return App;\n}(Component);\n\nexport { App as default };","map":null,"metadata":{},"sourceType":"module"}